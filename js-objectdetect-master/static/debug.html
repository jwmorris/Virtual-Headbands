<!DOCTYPE html>
<html lang="en">
<head>

<meta name="apple-mobile-web-app-capable" content="yes" charset="UTF-8" />
<link rel="stylesheet" type="text/css" href="css/debug_theme.css">
<script src="//code.jquery.com/jquery-1.11.1.min.js"></script>
<script src="//webrtc.github.io/adapter/adapter-latest.js"></script>
<meta name="viewport" content="width=device-width" />



<style type="text/css">
	#test {
		/*border: 2px solid cyan;*/
		z-index: 2;
		position: absolute;
	}
</style>

<script src="js/compatibility.js"></script>
	<script src="js/smoother.js"></script>
	<script src="canvas.js"></script>
	<script src="video.js"></script>
	<script src="../js/objectdetect.js"></script>
	<script src="../js/objectdetect.frontalface_alt.js"></script>
	<script src="../js/objectdetect.mouth.js"></script>
	<script>
			// getUserMedia only works over https in Chrome 47+, so we redirect to https. Also notify user if running from file.
			if (window.location.protocol == "file:") {
				alert("You seem to be running this example directly from a file. Note that these examples only work when served from a server or localhost due to canvas cross-domain restrictions.");
			} else if (window.location.hostname !== "localhost" && window.location.protocol !== "https:"){
				window.location.protocol = "https";
			}
		</script>
		
		<script>
		/*
			var oldURL = document.referrer;
			alert(oldURL);
			//var shopifyHeadband = oldURL.substr(oldURL.lastIndexof('/') + 1);
			//alert(shopifyHeadband);
			*/
		</script>
		

	<script>
	window.onload = function() {
		var heightIncrement = 0;
		var widthIncrement = 0;
		var smoother = new Smoother([0.9999999, 0.9999999, 0.999, 0.999], [0, 0, 0, 0]),
			video = document.getElementById('video'),
			test = document.getElementById('test'),
			testContext = test.getContext('2d'),
			headband = document.getElementById('headband'),
			detector,
			detector1,
			detector2,
			detector3;
			document.getElementById('productName').innerText = headband.alt;
				
		try {
			compatibility.getUserMedia({video: true}, function(stream) {
				try {
					video.src = compatibility.URL.createObjectURL(stream);
				} catch (error) {
					video.src = stream;
				}
				compatibility.requestAnimationFrame(play);
			}, function (error) {
				alert('WebRTC not available');
			});
		} catch (error) {
			alert(error);
		}
		
		function play() {
			compatibility.requestAnimationFrame(play);
			if (video.paused) video.play();
			
			fitVideo();
			fitCanvas();
			var testContext = test.getContext('2d');
			testContext.clearRect(0, 0, test.width, test.height);
			testContext.drawImage(logo, 0, 0, test.width/3, ((test.width/3)*173/560));
          	//testContext.drawImage(video, 0, 0, video.videoWidth, video.videoHeight, ((test.width - (video.videoHeight/video.videoWidth)*test.width)/2), 0, (video.videoHeight/video.videoWidth)*test.width, test.height);
			if (video.readyState === video.HAVE_ENOUGH_DATA && video.videoWidth > 0) {
	          	
	          	// Prepare the detector once the video dimensions are known:
	          	if (!detector) {
		      		var width = ~~(80 * test.width / test.height);
					var height = 80;
					//var width = ~~(60 * test.width / test.height);
					//var height = 60;
					//console.log("DETECTOR WIDTH: " + width + ", HEIGHT: " + height);
					//var width = test.width;
					//var height = test.height;
		      		detector = new objectdetect.detector(width, height, 1.1, objectdetect.frontalface_alt);
		      	}
          		
          		// Perform the actual detection:
				var left = parseInt(test.style.left);
				var top = parseInt(test.style.top);
				var roi =  [ left, top, test.width, test.height ];
				console.log("LEFT: " + left + ", TOP: " + top + ", WIDTH: " + test.width + ", HEIGHT: " + test.height);
				//var coords = detector.detect(video, 1, 2, roi);
				var coords = detector.detect(video, 1, 1);
				if (coords[0]) {
					var coord = coords[0];
					coord = smoother.smooth(coord);
					//var windowWidth = window.innerWidth
					
					// Rescale coordinates from detector to video coordinate space:
					//var testContext = test.getContext('2d');
					
					/*
					testContext.strokeRect(coord[0], coord[1], coord[2], coord[3])
					coord[0] *= video.offsetWidth / detector.canvas.width;
					coord[1] *= video.offsetHeight / detector.canvas.height;
					coord[2] *= video.offsetWidth / detector.canvas.width;
					coord[3] *= video.offsetHeight / detector.canvas.height;
					testContext.strokeRect(coord[0], coord[1], coord[2], coord[3])
					
					*/
					
					//testContext.drawImage(logo, 0, 0, this.width, this.height);
					
					testContext.strokeRect(0, 0, detector.canvas.width, detector.canvas.height);
					testContext.strokeRect(coord[0], coord[1], coord[2], coord[3]);
					
					coord[0] *= test.width / detector.canvas.width;
					coord[1] *= test.height / detector.canvas.height;
					coord[2] *= test.width / detector.canvas.width;
					coord[3] *= test.height / detector.canvas.height;
					
					testContext.strokeRect(coord[0], coord[1], coord[2], coord[3])
					testContext.drawImage(headband, coord[0], coord[1]  - (.5 * coord[3]), coord[2], coord[3]);
					
					//coord[0] = coord[0] * ( test.width / detector.canvas.width ) + left;
					//coord[1] = coord[1] * ( test.height / detector.canvas.height ) + top;
					//coord[2] *= video.offsetWidth / detector.canvas.width;
					//coord[3] *= video.offsetHeight / detector.canvas.height;
					
					//upButton.onclick = function(){
					//	if(increment + coord[1] > 0) {	
					//		increment -= 10;
					//	}
					//}
					//downButton.onclick = function(){
					//  if((increment + coord[1])< video.offsetHeight) {
					//	increment += 10;
					//  }
					//}
					//heightIncrement = document.getElementById('sliderHeight').value;
					//heightIncrement = heightIncrement - 50;
					
					//widthIncrement = document.getElementById('sliderWidth').value;
					//widthIncrement = widthIncrement - 50;
					
					// Display headband overlay: 
					/*
					headband.style.left    = (coord[0] + (windowWidth - video.offsetWidth)/2) - widthIncrement + 'px';
					headband.style.top     = (coord[1] - (detector.canvas.height*2)) + heightIncrement * (1.5) + 'px';
					headband.style.width   = (coord[2] *.9) + widthIncrement * (1.5) + 'px';
					headband.style.height  = (coord[3] *.9) + 'px';
					headband.style.display = "block";
					*/
					// that new new
					/*
					headband.style.left    = `${coord[0] + left}px`;
					headband.style.top     = `${coord[1]*.2 + top}px`;
					headband.style.width   = `${coord[2]}px`;
					headband.style.height  = `${coord[3]}px`;
					headband.style.display = "block";
					*/
					/*
					if(!detector1) {
						//create detector for mouth
						var detector1width = ~~(80 * coord[2] / coord[3]); //scale down
						var detector1height = 80/2;
						detector1 = new objectdetect.detector(detector1width, detector1height, 1.1, objectdetect.mouth);
					}
					
					var detector1OffsetLeft = coord[0];
					var detector1OffsetTop = coord[1];
					var roi1 = [ coord[0], ( coord[1] + coord[3]/2), coord[2], coord[3] ]; 
					var coords1 = detector1.detect(video, 1, 1, roi1);
					if(coords1[0]) {
						var coord1 = coords1[0];
						coord1 = smoother.smooth(coord1);
						testContext.strokeRect(coord1[0], coord1[1], coord1[2], coord1[3])
					} else {
						//headband.style.display = "none";
					}
					*/
				} else {
					headband.style.display = "none";
				}
			}
		}
		
		
		
		/**[].slice.call(document.getElementById('list').children).forEach(function(e) {
			if(e.tagName.toLowerCase() == 'img'){e.addEventListener('click', function() {
					headband.src = e.src;
					document.getElementById('productName').innerText = e.alt;
			}, false);
		}});
		
		[].slice.call(document.getElementById('overlayList').children).forEach(function(e) {
			if(e.tagName.toLowerCase() == 'img'){e.addEventListener('click', function() {
					headband.src = e.src;
					document.getElementById('productName').innerText = e.alt;
			}, false);
		}});**/
		
		window.addEventListener("resize", resizeVideo, false);
			var width = window.innerWidth;
			console.log("width: " + width);
			var height = window.innerHeight;
			/*var aspRatio = video.videoHeight/video.videoWidth;*/
			//console.log("video aspect ratio: " + aspRatio);
			console.log("video width: " + video.videoWidth);
			console.log("video height: " + video.videoHeight);
			console.log("height: " + height);
			//video.height = height;
			//video.width = width;
			//if(height > width) {
			//	video.width = width;
			//} else {
			//	video.height = height;
			//}
		console.log("video height: " + video.offsetHeight);
		console.log("video width: " + video.offsetWidth);
		function resizeVideo() {
		/*
			width = window.innerWidth;
			console.log("width: " + width);
			height = window.innerHeight;
			console.log("height: " + height);
			if(height > width) {
				video.width = width;
				video.height =
			} else {
			
				video.height = height;
				video.left = (width - video.offsetWidth)/2;
			}

			test.left = video.left;
			test.height = video.offsetHeight;
			test.width = video.offsetWidth;
			test.top = video.top;
			
			test.bottom = video.bottom;
		*/
			fitVideo();
			fitCanvas();
			detector = null;
		}
	};
	
	
	
    </script>
</head>
<body>
<canvas id="canvas"; visibility: hidden></canvas>
<video  muted autoplay playsinline id="video" class="vid"></video>
<canvas id="test" class="vid"></canvas>
<script>
	fitVideo();
	fitCanvas();
</script>
<img id="headband" src="img/flower.png" alt="Blue Flower" style="position: absolute; display: none;">

<!--<div class="updownedit" align="center">-->
		<!--<h1 style="color:#7ccdc9;">Edit Position</h1>-->
		<!--<img src="img/hohLogo.png" id="logo" top=0 left=0>-->
		<img src="img/hohLogo.png" id="logo" style="display: none;">
<!--</div>-->

<script>
/*
<div class="sidenav" id="list" align="center">
		<img src="img/flower.png" alt="Blue Flower" style="width: 125px;">
		<img src="img/headband_mesh.png" alt="Mesh Headband" style="width: 125px;">
		<img src="img/headband_stones.png" alt="Stones Flower" style="width: 125px;">
		<img src="img/headband_floral.png" alt="Floral Headband" style="width: 125px;">
		<img src="img/414.png" alt="White Flower" style="width: 125px;">
		<button onclick="openNav()">More Headbands</button>
</div>

<div id="sidenavbig" class="sidenavbig">
		<a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>

		<div id="overlayList" class="overlayList" align="center">
			<h1 style="color:white;"> Additional Headbands</h1>
			<img src="img/flower.png" alt="Blue Flower" style="width: 125px;">
			<img src="img/headband_mesh.png" alt="Mesh Headband" style="width: 125px;">
			<img src="img/headband_stones.png" alt="Stones Flower" style="width: 125px;">
			<img src="img/headband_floral.png" alt="Floral Headband" style="width: 125px;">
			<img src="img/414.png" alt="White Flower" style="width: 125px;">
			<img src="img/Bohemian_Headband.png" style="width: 125px;">
			<img src="img/Cat_Ear_Headband.png" style="width: 125px;">
			<img src="img/Fire_Headband.png" style="width: 125px;">
			<img src="img/H.png" style="width: 125px;">
			<img src="img/Rising_Sun_Headband.png" style="width: 125px;">
			<img src="img/Red.png" style="width: 125px;">
			<img src="img/414.png" alt="White Flower" style="width: 125px;">
		</div>
</div>
*/
</script>

<img id="logo" src="img/HOH_logo.png" visibility: hidden>
<!-- Optional: some overlay text to describe the video -->
<div class="content" align="center">
  <!-- <h1>Headbands of Hope Virtual Closet</h1> -->
  <h1 id = productName> Product Name </h1>
  <!-- Use a button to pause/play the video with JavaScript -->
  <button id="Add to Cart"  class="bottom_buttons" onclick="addToCart()">Add to Cart</button>
  <button id="take_picture" class="bottom_buttons" onclick="snap()">Take a picture</button>
  <button id="checkout" class="bottom_buttons" onclick="checkout()">Checkout</button>

</div>
<script>
/**document.addEventListener('DOMContentLoaded', function(){
	var v = document.getElementById('video');
	var canv = document.getElementById('test');
	var context = canv.getContext('2d');
	
	var cw = canv.width;
	var ch = canv.height;
	
	v.addEventListner('play', function(){
		draw(this, context, cw, ch);
	}, false);
		
}, false);

function draw(v, c, width, height) {
	if(v.paused || v.ended) return false;
	var leftOffset = 0;
	var downOffset = 0;
	//if(v.width > v.height) {
		//height = height*(v.height/v.width);
		//downOffset = Math.floor((canv.height - height)/2);
	//} else {
	//	width = width*(v.width/v.height);
		//leftOffset = Math.floor((canv.width - width)/2);
	//}
	c.drawImage(v, leftOffset, downOffset, width, height);
	setTimeout(draw, 20, v, c, width, height);
}
**/
</script>
<script src="canvas.js"></script>
<script>
		// Get handles on the video and canvas elements
		var hb = document.getElementById('headband');
		var video = document.getElementById('video');
		var canvas = document.getElementById('canvas');
		var logo = document.getElementById('logo');
		// Get a handle on the 2d context of the canvas element
		var context = canvas.getContext('2d');
		// Define some vars required later
		var w, h, ratio;
		// Add a listener to wait for the 'loadedmetadata' state so the video's dimensions can be read
		video.addEventListener('loadedmetadata', function() {
			h = video.offsetHeight;
			w = video.offsetWidth;			
			// Set the canvas width and height to video size
			canvas.width = w;
			canvas.height = h;	
		}, false);
		
		// Takes a snapshot of the video
		function snap() {
			// Draw screenshot, headband, and HOH logo on canvas
			context.drawImage(video, 0, 0, w, h);
			context.drawImage(hb, (hb.offsetLeft - (window.innerWidth - w)/2), hb.offsetTop, hb.width, hb.height);
			context.drawImage(logo, 0, 0, 200, 200);
			//Open new tab and draw image on it
    	var win=window.open();
    	win.document.body.innerHTML = "'<img src="+canvas.toDataURL("image/png")+">'";
		}
		 
	</script>
	
	<script>
	function openNav() {	
		document.getElementById("sidenavbig").style.width = "100%";
	}

	function closeNav() {
		document.getElementById("sidenavbig").style.width = "0";
	}
	</script>
	
	<script>
	var cartSize = 0;
	var headBandArray = [];
	function addToCart() {
		
		cartSize = cartSize + 1;
		headBandArray[headBandArray.length] = document.getElementById('productName').innerText;
		//Add to an array
		
		document.getElementById('checkout').innerHTML = "Checkout (" + cartSize + ")" ;
	}
	function checkout() {
		var contents = "";
		for(i = 0; i < headBandArray.length; i++) {
			contents += headBandArray[i] + "\n";
		}
		var direct = confirm("You are heading to checkout with:\n" + contents );
		if (direct==true) {
			window.location.replace("https://www.headbandsofhope.com/");
			//https://www.headbandsofhope.com/cart
		} else {
			alert("wut, buy our headbands yo");
		}
	}
	</script>
	
</body>
</html>
